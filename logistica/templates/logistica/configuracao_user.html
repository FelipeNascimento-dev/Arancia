{% extends 'global/base.html' %}
{% load static %}

{% block content %}

<div class="profile-modal">
  <div class="profile-header">
    <h2>Meu Perfil</h2>
    <a class="btn-link" href="#" onclick="history.back();return false;">✕</a>
  </div>

  <div class="profile-tabs">
    <a class="profile-tab active" href="javascript:void(0)">Dados do Usuário</a>
  </div>

  <div class="profile-body">
    <form method="post" enctype="multipart/form-data" action="{% url 'logistica:settings' %}">
      {% csrf_token %}

      <div class="profile-grid">
        <div class="avatar-col">
          <label class="avatar" id="avatarPreview">
            <img class="foto-perfil" src="{{ avatar_url }}" alt="foto">
          </label>

          <input type="file" name="foto_perfil" id="id_foto_perfil" accept="image/*" class="file-input-visually-hidden">

          <button type="button" class="avatar-btn" id="btnAlterarFoto">
            Alterar foto
          </button>
        </div>

        <div class="fields">
          <div class="form-group">
            <label for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
            {{ form.username }} {{ form.username.errors }}
          </div>
          <div class="form-group">
            <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
            {{ form.email }} {{ form.email.errors }}
          </div>
          <div class="form-group">
            <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}</label>
            {{ form.first_name }} {{ form.first_name.errors }}
          </div>
          <div class="form-group">
            <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}</label>
            {{ form.last_name }} {{ form.last_name.errors }}
          </div>

          <div class="form-group" id="grpSenhaAtual">
            <label for="{{ form.senha_atual.id_for_label }}" class="label">
              {{ form.senha_atual.label }}
            </label>
            <div class="input-with-eye">
              {{ form.senha_atual }}
              <button type="button" class="eye-btn" data-eye="senha_atual" aria-label="Mostrar/ocultar senha">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
            <small class="helper">Para trocar sua senha, clique em “Alterar senha”.</small>
          </div>


          <label for="{{ form.senha_atual.id_for_label }}" class="label">
            <a href="#" id="btnToggleSenha" class="btn btn-outline btn-outline-input" aria-expanded="false">
              <i class="fa-solid fa-key" aria-hidden="true"></i>
              <span>Alterar senha</span>
            </a>
          </label>

          <div class="form-group hidden" id="grpNovaSenha1">
            <label for="{{ form.nova_senha1.id_for_label }}" class="label">
              {{ form.nova_senha1.label }}
            </label>
            <div class="input-with-eye">
              {{ form.nova_senha1 }}
              <button type="button" class="eye-btn" data-eye="nova_senha1" aria-label="Mostrar/ocultar senha">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="form-group hidden" id="grpNovaSenha2">
            <label for="{{ form.nova_senha2.id_for_label }}" class="label">
              {{ form.nova_senha2.label }}
            </label>
            <div class="input-with-eye">
              {{ form.nova_senha2 }}
              <button type="button" class="eye-btn" data-eye="nova_senha2" aria-label="Mostrar/ocultar senha">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

        </div>
      </div>

      <div class="actions">
        <div></div>
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const inputFoto = document.getElementById('id_foto_perfil');
    const preview = document.getElementById('avatarPreview');
    if (inputFoto && preview) {
      inputFoto.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const url = URL.createObjectURL(f);
        preview.style.backgroundImage = `url('${url}')`;
      });
    }

    const btnToggle = document.getElementById('btnToggleSenha');
    const grp1 = document.getElementById('grpNovaSenha1');
    const grp2 = document.getElementById('grpNovaSenha2');

    let aberto = false;
    btnToggle?.addEventListener('click', (e) => {
      e.preventDefault();
      aberto = !aberto;
      grp1.classList.toggle('hidden', !aberto);
      grp2.classList.toggle('hidden', !aberto);
      btnToggle.textContent = aberto ? 'Cancelar' : 'Alterar senha';

      if (!aberto) {
        const i1 = document.getElementById('id_nova_senha1');
        const i2 = document.getElementById('id_nova_senha2');
        if (i1) i1.value = '';
        if (i2) i2.value = '';
      }
    });

    document.querySelectorAll('.eye-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-eye');
        const input = document.getElementById('id_' + name);
        const icon = btn.querySelector('i');
        if (!input || !icon) return;

        if (input.type === 'password') {
          input.type = 'text';
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        } else {
          input.type = 'password';
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        }
      });
    });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('id_foto_perfil');
    const btn = document.getElementById('btnAlterarFoto');
    const img = document.querySelector('.foto-perfil');
    btn.addEventListener('click', () => input.click());
    input.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) img.src = URL.createObjectURL(file);
    });
  });
</script>
{% endblock content %}
{% extends 'global/base.html' %}

{% block content %}

<style>
    .form-card-2col {
        height: auto;
        margin-top: 65px;
    }
</style>

<div class="form-container">
    <div class="form-card-2col" action="{{ form_action }}" method="POST">
        <form method="POST">
            {% include 'global/partials/_form_2col.html' %}
        </form>
    </div>
</div>

{% if request.resolver_match.url_name == 'recebimento_remessa' %}
<div class="confirm-clear" id="confirm-clear" aria-hidden="true" role="dialog" aria-modal="true"
    aria-labelledby="cc-title" aria-describedby="cc-desc">
    <div class="confirm-clear__backdrop" data-close="1"></div>
    <div class="confirm-clear__dialog">
        <h3 id="cc-title">Limpar seriais?</h3>
        <p id="cc-desc">Todos os seriais bipados serão descartados.<br>
            Esta ação NÃO pode ser desfeita!
        </p>

        <div class="confirm-clear__actions">
            <button type="button" class="submit-button-right cc-no" data-close="1">Cancelar</button>
            <button type="button" class="submit-button-right" id="cc-yes">Sim, limpar</button>
        </div>
    </div>
</div>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById("id_box_codes");

        if (input) {
            input.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                    e.preventDefault();  // impede submit da tela

                    // cria input hidden simulando button add_serial
                    const form = input.form;
                    const hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "add_serial";
                    hidden.value = "1";
                    form.appendChild(hidden);

                    form.submit();
                }
            });
        }
    });
</script>

<script>
    (function () {
        const MAP = JSON.parse('{{ depositos_map_json|escapejs }}');

        function fill(select, options) {
            select.innerHTML = '';
            select.add(new Option('', ''));
            (options || []).forEach(function (item) {
                select.add(new Option(item[1], item[0]));
            });
        }

        function wirePair(idCentro, idDeposito) {
            const c = document.getElementById(idCentro);
            const d = document.getElementById(idDeposito);
            if (!c || !d) return;

            if (!c.value) {
                d.disabled = true;
            }

            c.addEventListener('change', function () {
                fill(d, MAP[c.value]);
                d.disabled = !c.value;
                d.value = '';
            });

            if (c.value) {
                fill(d, MAP[c.value]);
                d.disabled = false;
            }
        }

        wirePair('id_distribution_center', 'id_ware_house_code');
    })();
</script>

{% endblock content %}


<div class="setcontainer">


<!-- TABELA DE TÉCNICOS -->
<div id="tabela-tecnicos" {% if filtro_ativo or ver_rota_uid %}style="display:none"{% endif %} >
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
  {% endfor %}
{% endif %}

  <h4>Resumo por Técnico</h4>
  <div class="table-responsive">
    {% if tecnicos %}
    <table class="styled-table dark table-sd">
      <thead>
        <tr>
          <th>Ação</th><th>Nome</th><th>UID</th><th>Unidade</th>
          <th>Total OS</th><th>Concluído</th><th>No Tempo</th><th>No Limite</th>
          <th>Atrasado</th><th>Último Login</th><th>Última Abertura</th><th>Tempo Ocioso</th>
          <th>Ultimo Contato</th><th>Contato Feito por</th>
        </tr>
      </thead>
  <tbody>
  {% for t in tecnicos %}
    {% if t.uid %}
      <tr {% if t.atraso_min > 29 %}class="alert-row"{% endif %}>
        <td>
          <a href="{% url 'transportes:registrar_tratamento' t.uid %}"
             data-bs-toggle="modal"
             data-bs-target="#modalTecnico"
             data-nome="{{ t.nome }}"
             data-uid="{{ t.uid }}"
             data-area="{{ t.area }}"
             data-total="{{ t.total }}"
             data-concluido="{{ t.concluido }}"
             data-no-tempo="{{ t.no_tempo }}"
             data-no-limite="{{ t.no_limite }}"
             data-atrasado="{{ t.atrasado }}"
             data-lastlogin="{{ t.lastlogin }}"
             data-lastopening="{{ t.lastopening }}"
             data-ocioso="{{ t.atraso_fmt }}"
             data-hoje="{{ t.quantity_treatments_day }}"
             data-contatogeral="{{ t.quantity_treatments }}"
             data-phone="{{ t.phone }}">
             <i class="fa-regular fa-eye {% if t.atraso_min > 29 %}icon-alert{% endif %}"></i>
          </a>
        </td>

        <td>{{ t.nome }}</td>
        <td>{{ t.uid }}</td>
        <td>{{ t.area }}</td>
        <td>{{ t.total }}</td>
        <td>{{ t.concluido }}</td>
        <td>{{ t.no_tempo }}</td>
        <td>{{ t.no_limite }}</td>
        <td>{{ t.atrasado }}</td>
        <td>{{ t.lastlogin }}</td>
        <td>{{ t.lastopening }}</td>
        <td>{{ t.atraso_fmt }}</td>

        {% if t.last_treatment and t.last_treatment|slice:":10" != hoje|date:"d/m/Y" %}
          <td colspan="2">-</td> {# Não mostrar dados antigos #}
        {% else %}
          <td>{{ t.last_treatment }}</td>
          <td>{{ t.person_treated }}</td>
        {% endif %}
      </tr>
    {% endif %}
  {% empty %}
    <tr><td colspan="14">Nenhum técnico encontrado</td></tr>
  {% endfor %}
</tbody>

    </table>
    {% endif %}
    
  </div>
</div>

<!-- TABELA DE ORDENS FILTRADAS -->
<div id="tabela-ordens" {% if not filtro_ativo or ver_rota_uid %}style="display:none"{% endif %} > <h4>Ordens Atendidas</h4>
  <div class="table-responsive">
    
    <table class="styled-table dark">
      
      <thead>
        <tr>
          <th>Ação</th><th>OS</th><th>Técnico</th><th>UID</th>
          <th>Horário</th><th>Tempo Restante</th><th>Status</th>
          <th>Tag</th><th>ocorrencia</th><th>Flag</th><th>OBS</th>
        </tr>
      </thead>
      <tbody>
        {% for o in ordens %}
        <tr class="status-{{ o.status_janela|default:'' }} flag-{{ o.flag|default:'' }}">
          <td>
          <a href="#" data-bs-toggle="modal" data-bs-target="#modalOrdem"
          data-nome="{{ o.nome_tecnico|default:'' }}" data-os="{{ o.os |default:""  }}"   data-uid="{{ o.uid |default:"" }}"
            data-horario="{{ o.alteracao_hf |default:"" }}" data-tempo="{{ o.tempo_restante|default:""  }}" data-longitude="{{ o.longitude|default:""  }}" data-latitude="{{o.latitude|default:""}}" data-imageurl="{{o.imageurl|default:'-'}}"
            data-endereco="{{ o.endereco |default:"" }}" data-status="{{ o.status_janela |default:"" }}"
            data-tag="{{ o.tag |default:"" }}" data-flag="{{ o.flag|default:""  }}" data-mensagem="{{ o.mensagem|default:""  }}">
            <i class="fa-regular fa-eye"></i>
          </a>
        </td>

          <td>{{ o.os|default:""  }}</td><td>{{ o.nome_tecnico |default:"" }}</td><td>{{ o.uid|default:""  }}</td>
          <td>{{ o.alteracao_hf|default:"" }}</td><td>{{ o.tempo_restante |default:"" }}</td>
        <td class="status {{ o.status_janela }}">{{ o.status_janela |default:"" }}</td>
          <td>{{ o.tag |default:"" }}</td><td>{{ o.ocorrencia |default:"" }}</td><td class="flag {{ o.flag }}">{{ o.flag |default:"" }}</td>
          <td class="mensagem {{ o.mensagem }}">{{ o.mensagem|default:""  }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="11">Nenhuma ordem encontrada</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
<!-- CONTROLES DE PAGINAÇÃO -->
<div id="pagination-controls" class="d-flex justify-content-center mt-3">
  <button id="prev-page" class="btn btn-outline-secondary btn-sm me-2" disabled>Anterior</button>
  <span id="page-info" class="align-self-center">Página 1</span>
  <button id="next-page" class="btn btn-outline-secondary btn-sm ms-2">Próxima</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Seleciona as linhas dentro da tabela de ordens
  const tabela = document.querySelector("#tabela-ordens table");
  if (!tabela) return; // segurança: não faz nada se a tabela não existe

  const rows = tabela.querySelectorAll("tbody tr");
  if (!rows.length) return; // se não tem linhas, sai

  const rowsPerPage = 100; // número de linhas por página
  let currentPage = 1;
  const totalPages = Math.ceil(rows.length / rowsPerPage);

  const prevBtn = document.getElementById("prev-page");
  const nextBtn = document.getElementById("next-page");
  const pageInfo = document.getElementById("page-info");

  function renderPage(page) {
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    rows.forEach((row, index) => {
      row.style.display = (index >= start && index < end) ? "" : "none";
    });

    pageInfo.textContent = `Página ${page} de ${totalPages}`;
    prevBtn.disabled = (page === 1);
    nextBtn.disabled = (page === totalPages);

    // rola até o topo da tabela
    tabela.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  prevBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderPage(currentPage);
    }
  });

  nextBtn.addEventListener("click", () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderPage(currentPage);
    }
  });

  // Mostra a primeira página ao carregar
  renderPage(currentPage);
});
</script>
</div>

<!-- TABELA DETALHADA POR TÉCNICO (MODAL) -->
<div id="tabela-filtrada"{%if not ver_rota_uid %}style="display:none"{% endif %} >
  <div class="d-flex justify-content-between align-items-center mb-2">
    {% if ordens_os %}
    <h4 style='color:#168dd8;'>
      Ordens Detalhadas - Técnico: {{ ordens_os.0.nome_tecnico |default:"" }} (UID: {{ ordens_os.0.uid }})
    </h4>
  {% else %}
    <h4>Ordens Detalhadas</h4>
  {% endif %}
       <a href="{{ request.path }}" style="background:#4a90e2;"class="btn btn-secondary btn-sm">
      ← Voltar para Técnicos
    </a>
    
  </div>
  <div>

  <div class="table-responsive">
   
    <table class="styled-table dark">
      <thead>
        <tr>
          <th>Ação</th><th>OS</th><th>Horario</th><th>Tempo Restante</th>
          <th>Status</th><th>Tag</th><th>ocorrencia</th><th>Flag</th><th>OBS</th>
        </tr>
      </thead>
      <tbody>
        {% for o in ordens_os %}
        <tr class="ordem-linha" data-uid="{{ o.uid }}">
          <td> <a href="#" data-bs-toggle="modal" data-bs-target="#modalOrdem"
           data-nome="{{ o.nome_tecnico |default:"" }}"  data-os="{{ o.os|default:""  }}" data-uid="{{ o.uid|default:""  }}"
            data-horario="{{ o.alteracao_hf |default:""  }}" data-tempo="{{ o.tempo_restante |default:""  }}" data-longitude="{{ o.longitude|default:""  }}" data-latitude="{{o.latitude|default:""}}" data-imageurl="{{o.imageurl|default:'-'}}"
            data-endereco="{{ o.endereco |default:"" }}" data-status="{{ o.status_janela |default:"" }}"
            data-tag="{{ o.tag|default:""  }}" data-flag="{{ o.flag|default:""  }}" data-mensagem="{{ o.mensagem|default:""  }}">
            <i class="fa-regular fa-eye"></i>
          </a></td>
          <td>{{ o.os }}</td><td>{{o.alteracao_hf |default:""  }}</td>
           <td>{{ o.tempo_restante |default:"" }}</td><td class="status {{ o.status_janela }}">{{ o.status_janela |default:"" }}</td><td>{{ o.tag |default:"" }}</td>
           <td>{{ o.ocorrencia |default:"" }}</td><td class="flag {{ o.flag }}">{{ o.flag |default:""  }}</td>
           <td class="mensagem {{ o.mensagem }}">{{ o.mensagem |default:"" }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="9">Nenhuma ordem detalhada encontrada</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
</div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let tecnicoAtual = null;

  // Quando o usuário clica em um técnico da tabela para abrir o modal
  document.querySelectorAll('[data-bs-target="#modalTecnico"]').forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();

      tecnicoAtual = {
        url: link.getAttribute("href"),
        uid: link.dataset.uid,
        row: link.closest("tr")
      };

      // opcional: limpar cor anterior
      if (tecnicoAtual.row) {
        tecnicoAtual.row.style.backgroundColor = "";
      }
    });
  });

  // Quando clicar no link do WhatsApp dentro do modal
  const linkZap = document.getElementById("modalTecPhone");
  if (linkZap) {
    linkZap.addEventListener("click", async (e) => {
      if (!tecnicoAtual?.url || !tecnicoAtual?.row) return;

      try {
        const res = await fetch(tecnicoAtual.url);
        const data = await res.json();

        if (data.ok) {
          const now = new Date();
          const fmt = now.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
          const campo = tecnicoAtual.row.querySelector('[data-field="last_treatment"]');
          if (campo) campo.textContent = fmt;
          tecnicoAtual.row.style.backgroundColor = "#d4edda";
          console.log(`Técnico ${tecnicoAtual.uid} tratado via link WhatsApp`);
        }
      } catch (err) {
        console.error("Erro ao tratar:", err);
      }
    });
  }
});
</script>

{% extends 'global/base.html' %} {% block content %}

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>

<div class="container mt-4">
  <h2 class="mb-3">T√©cnicos</h2>
  <div class="row">
    {% for tec in tecnicos %}
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ tec.name }}</h5>
          <p class="card-text">
            <strong>UID:</strong> {{ tec.uid }}<br />
            <strong>Email:</strong> {{ tec.email }}
          </p>
          <button
            class="btn btn-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#editModal"
            data-uid="{{ tec.uid }}"
          >
            Editar
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal para editar t√©cnico -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">Editar T√©cnico</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="uid" name="uid" />
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              <input type="text" class="form-control" id="name" name="name" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefone</label>
              <input type="text" class="form-control" id="phone" name="phone" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="text" class="form-control" id="email" name="email" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Unidade</label>
              <input
                type="text"
                class="form-control"
                id="nome_unidade"
                name="nome_unidade"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" id="status" name="status">
                <option>Ativo</option>
                <option>Folga</option>
                <option>Suspenso</option>
                <option>Falta</option>
                <option>Se Acidentou</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = "http://192.168.0.214/RetencaoAPI/api/v3";
  const API_TOKEN = "123";

  document.addEventListener("DOMContentLoaded", () => {
    const editModal = document.getElementById("editModal");
    const form = document.getElementById("editForm");

    // Quando abrir o modal
    editModal.addEventListener("show.bs.modal", async (event) => {
      const button = event.relatedTarget;
      const uid = button.getAttribute("data-uid");
      document.getElementById("uid").value = uid;

      console.log("üîç Buscando t√©cnico UID:", uid);

      const resp = await fetch(`${API_BASE}/update/${uid}`, {
        headers: {
          "Content-Type": "application/json",
          access_token: API_TOKEN,
        },
      });

      if (!resp.ok) {
        alert("Erro ao carregar dados do t√©cnico");
        return;
      }

      const data = await resp.json();
      console.log("‚úÖ Dados recebidos:", data);

      // Preencher os campos
      document.getElementById("username").value = data.username || "";
      document.getElementById("name").value = data.name || "";
      document.getElementById("phone").value = data.phone || "";
      document.getElementById("email").value = data.email || "";
      document.getElementById("nome_unidade").value = data.nome_unidade || "";
      document.getElementById("documento").value = data.documento || "";
      document.getElementById("profile").value = data.profile || "";
      document.getElementById("status").value = data.status || "Ativo";
    });

    // PUT atualiza√ß√£o
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const uid = document.getElementById("uid").value;
      const payload = Object.fromEntries(new FormData(form));

      console.log("‚úèÔ∏è Atualizando t√©cnico:", uid, payload);

      const resp = await fetch(`${API_BASE}/update/${uid}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          access_token: API_TOKEN,
        },
        body: JSON.stringify(payload),
      });

      if (resp.ok) {
        alert("‚úÖ T√©cnico atualizado com sucesso!");
        location.reload();
      } else {
        const error = await resp.text();
        alert("‚ùå Erro ao atualizar t√©cnico: " + error);
      }
    });
  });
</script>

{% endblock %}

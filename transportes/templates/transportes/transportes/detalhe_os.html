{% extends 'global/base.html' %}

{% block content %}

<style>
    .os-container {
        margin-left: 50px;
        margin-top: 50px;
        /* width: calc(100% - 80px); */
        height: auto;
    }

    .os-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        width: 100%;
    }

    #card-location,
    #card-destination {
        transition: 0.2s;
        cursor: pointer;
        height: 250px;
        min-width: 625px;
    }

    .content-wrapper {
        padding: 30px;
    }

    .header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .os-card.header {
        width: 100%;
        min-width: 100%;
        box-sizing: border-box;
    }

    .header-left {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .icon-box {
        background: #e8f2ff;
        padding: 14px;
        border-radius: 10px;
        font-size: 20px;
    }

    .title {
        font-size: 20px;
        font-weight: 600;
    }

    .subtitle {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
    }

    .btn-primary {
        background: #1e90ff;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .summary {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .summary-number {
        font-size: 22px;
        font-weight: 600;
    }

    .summary-status {
        font-size: 18px;
        font-weight: 600;
    }

    .summary-icon {
        padding: 14px;
        border-radius: 10px;
        font-size: 18px;
    }

    .blue {
        background: #e8f2ff;
    }

    .orange {
        background: #fff2e8;
    }

    .green {
        background: #e9f7ef;
    }

    .yellow {
        background: #fff9e6;
    }

    .route-grid {
        display: grid;
        grid-template-columns: 1fr 80px 1fr;
        gap: 20px;
        align-items: center;
        margin-bottom: 25px;
    }

    .location-name {
        font-size: 18px;
        font-weight: 600;
        margin: 5px 0;
    }

    .location-address,
    .contact {
        font-size: 13px;
        color: #555;
        line-height: 1.6;
    }

    .divider {
        border-top: 1px solid #eee;
        margin: 15px 0;
    }

    .arrow {
        text-align: center;
        font-size: 24px;
        color: #bbb;
    }

    .table-card {
        padding: 0;
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #0e76bd;
        color: white;
    }

    th,
    td {
        padding: 14px 16px;
        font-size: 14px;
    }

    tbody tr {
        border-bottom: 1px solid #eee;
    }

    table th,
    table td {
        text-align: center;
        vertical-align: middle;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-yellow {
        background: #ffd54f;
    }

    .badge-blue {
        background: #2196f3;
        color: white;
    }

    .tab.active-solid {
        background: #0e76bd;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
    }

    .actions-row {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
    }

    .travel-card {
        padding: 0;
        margin-bottom: 20px;
        overflow: hidden;
        transition: all 0.25s ease;
    }

    .travel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 20px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .travel-header:hover {
        background: #f4f6f9;
    }

    .travel-body {
        max-height: 0;
        overflow: hidden;
        padding: 0 20px;
        transition: all 0.3s ease;
        opacity: 0;
    }

    .travel-card.active .travel-body {
        max-height: 500px;
        padding: 20px;
        opacity: 1;
    }

    .travel-arrow {
        font-size: 16px;
        color: #999;
        transition: transform 0.3s ease;
    }

    .travel-card.active .travel-arrow {
        transform: rotate(180deg);
    }

    .travel-title {
        font-size: 18px;
        font-weight: 600;
    }

    .travel-sub {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
    }

    .travel-info-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .info-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
    }

    .travel-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-secondary {
        background: #bebebe;
        border: 1px solid #ddd;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    .events-title {
        font-weight: 500;
        margin-bottom: 15px;
    }

    .event-item {
        display: flex;
        gap: 10px;
        background: #f4f6f9;
        padding: 14px;
        border-radius: 8px;
        font-size: 14px;
    }

    .event-dot {
        width: 8px;
        height: 8px;
        background: #0e76bd;
        border-radius: 50%;
        margin-top: 6px;
    }

    .event-author {
        font-size: 12px;
        color: #666;
        margin-top: 6px;
    }

    .arrow-collapse {
        font-size: 18px;
        color: #999;
    }

    .tabs-wrapper {
        background: #f4f6f9;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .tabs {
        display: flex;
        gap: 10px;
    }

    .tab {
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        color: #555;
        font-weight: 500;
        transition: 0.2s;
    }

    .tab.active {
        background: #0e76bd;
        color: white;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .cotacao-card {
        width: 100%;
        max-width: 400px;
        margin-bottom: 20px;
    }

    .cotacao-header {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
    }

    .cotacao-title {
        font-size: 16px;
        font-weight: 600;
    }

    .cotacao-sub {
        font-size: 12px;
        color: #777;
    }

    .cotacao-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .btn-success {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: #28a745;
        color: white;
        font-weight: 500;
        cursor: pointer;
    }

    .green-text {
        color: #28a745;
    }

    .timeline-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .timeline {
        position: relative;
        padding-left: 20px;
    }

    .timeline-item {
        border-left: 2px solid #ddd;
        padding-left: 15px;
        margin-left: 5px;
    }

    /* .timeline::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #ddd;
    } */

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-dot {
        width: 10px;
        height: 10px;
        background: #0e76bd;
        border-radius: 50%;
        position: absolute;
        left: -5.6px;
        top: 28px;
    }

    .timeline-card {
        background: #f4f6f9;
        padding: 15px;
        border-radius: 10px;
        font-size: 14px;
    }

    .timeline-meta {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
    }

    .dropdown {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        right: 0;
        top: 110%;
        background: white;
        width: 220px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 8px 0;
        display: none;
        z-index: 1000;
        animation: fadeIn 0.15s ease-in-out;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }

    .dropdown-item:hover {
        background: #f4f6f9;
    }

    .dropdown-divider {
        height: 1px;
        background: #eee;
        margin: 6px 0;
    }

    .dropdown-item.success {
        color: #28a745;
        font-weight: 500;
    }

    .dropdown-item.danger {
        color: #dc3545;
        font-weight: 500;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .location {
        padding: 22px;
    }

    .location-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .location-icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .blue-bg {
        background: #e8f2ff;
        color: #1e90ff;
    }

    .orange-bg {
        background: #fff2e8;
        color: #ff7a00;
    }

    .location-label {
        font-size: 12px;
        font-weight: 600;
        color: #888;
        letter-spacing: 1px;
    }

    .location-name {
        font-size: 17px;
        font-weight: 600;
        margin-top: 2px;
    }

    .location-address {
        font-size: 13px;
        color: #555;
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .contact-line {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #444;
        margin-bottom: 6px;
    }

    .contact-line i {
        color: #999;
        font-size: 13px;
    }

    .arrow-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #e8f2ff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e90ff;
        font-size: 16px;
        margin-left: 15px;
    }


    /* MODAL PARA CRIAR VIAGEM */

    /* MODAL */
    .os-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .os-modal-overlay.show {
        display: flex;
    }

    .os-modal {
        background: white;
        width: 650px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        animation: modalFade 0.2s ease-in-out;
    }

    @keyframes modalFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .os-modal-header {
        padding: 18px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }

    .os-modal-title {
        font-weight: 600;
        font-size: 18px;
    }

    .os-modal-close {
        cursor: pointer;
        font-size: 18px;
        color: #777;
    }

    .os-modal-body {
        padding: 20px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        margin-bottom: 20px;
    }

    .form-group label {
        font-size: 13px;
        color: #555;
        margin-bottom: 6px;
        display: block;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    .items-box {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        background: #f9fafc;
    }

    .items-title {
        font-weight: 500;
        margin-bottom: 10px;
    }

    .checkbox-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 14px;
        cursor: pointer;
    }

    .checkbox-item span {
        color: #777;
    }

    .os-modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .os-modal-lg {
        width: 720px;
    }

    .os-modal-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
    }

    /* MODAL ADICIONAR ITEM */
    .item-alert{
        border-radius:10px;
        padding:12px 14px;
        margin-bottom:14px;
        font-size:14px;
    }

    #modalItemContent {
        height: 720px;
        width: 800px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #modalItemBody {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    #modalItemBody::-webkit-scrollbar {
        width: 8px;
    }

    #modalItemBody::-webkit-scrollbar-thumb {
        background: #cfd8dc;
        border-radius: 6px;
    }

    #modalItemBody::-webkit-scrollbar-thumb:hover {
        background: #b0bec5;
    }

    .item-alert.success{ background:#e9f7ef; color:#1f7a3a; border:1px solid #bfe8cf; }
    .item-alert.error{ background:#fff2f2; color:#a12525; border:1px solid #f3bcbc; }

    textarea{
        width:100%;
        padding:10px;
        border-radius:8px;
        border:1px solid #ddd;
        font-size:14px;
        resize:vertical;
    }

    .subitens-container{
        display:flex;
        flex-direction:column;
        gap:10px;
    }

    .subitem-row{
        display:grid;
        grid-template-columns: 1.2fr 1.2fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 44px;
        gap:10px;
        align-items:end;
        padding:10px;
        border:1px solid #e6e6e6;
        border-radius:10px;
        background:#fff;
    }

    .subitem-row .form-group{ margin:0; }
    .subitem-row .remove-subitem{
        height:40px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        background:#f4f6f9;
    }
    .subitem-row .remove-subitem:hover{
        background:#ffeaea;
    }
    .subitem-row input{
        padding:10px;
        border-radius:8px;
        border:1px solid #ddd;
        font-size:14px;
    }

    .tab-content {
        width: 100%;
        overflow: visible;
    }

    .tab-pane {
        width: 100%;
    }

    .tab-content {
        display: block !important;
        width: 100%;
    }

    .tab-pane {
        display: none;
        width: 100%;
    }

    .tab-pane.active {
        display: block !important;
    }

    .content-wrapper {
        display: block !important;
    }

    .os-container {
        display: block !important;
    }

    .btn-subitens {
        background-color: transparent;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        color: black;
        cursor: pointer;
        font-size: 15px;
    }

    .btn-events {
        background-color: transparent;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        color: black;
        cursor: pointer;
        font-size: 15px;
    }

    .modal-scroll-limit {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 6px;
    }

    .travel-scroll {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .cotacoes-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }

    .driver-dropdown {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 60px;
        width: 300px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 9999;
    }

    .driver-item {
        padding: 8px 10px;
        cursor: pointer;
    }

    .driver-item:hover {
        background: #f4f6f9;
    }
</style>

<div class="os-container">
    <div class="content-wrapper">
        <div class="os-card header">
            <div class="header-left">
                <div class="icon-box"><i class="fa-solid fa-box" style="color: #74C0FC;"></i></div>
                <div>
                    <div class="title">
                        #{{ payload.service_order.order_number }}
                        <span class="badge badge-yellow">
                            {{ payload.service_order.order_state.type }}
                        </span>
                    </div>
                    <div class="subtitle">
                        {% if payload.service_order.external_order_number %}
                            OS Externa: {{ payload.service_order.external_order_number }} •
                        {% endif %}
                        {% if payload.service_order.order_type %}
                            Tipo: {{ payload.service_order.order_type.description }}
                        {% endif %}
                        {% if payload.service_order.created_by %}
                            • Criado por: {{ payload.service_order.created_by }}
                        {% endif %}
                        {% if payload.service_order.created_at %}
                            {% with iso=payload.service_order.created_at %}
                                • Data: {{ iso|slice:"8:10" }}/{{ iso|slice:"5:7" }}/{{ iso|slice:"0:4" }} {{ iso|slice:"11:16" }}
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="btn-primary dropdown-toggle">
                    Ações ▾
                </button>

                <div class="dropdown-menu">

                    <div class="dropdown-item" onclick="abrirModalCriarItem()">
                        <i class="fa-solid fa-list"></i> Adicionar Item
                    </div>

                    <div class="dropdown-item" onclick="abrirModalCotacao()">
                        <i class="fa-solid fa-plus"></i> Adicionar Cotação
                    </div>

                    <div class="dropdown-item" onclick="abrirModal()">
                        <i class="fa-solid fa-truck"></i> Criar Viagem
                    </div>

                    <div class="dropdown-divider"></div>

                    <div class="dropdown-item success">
                        <i class="fa-solid fa-check"></i> Finalizar OS
                    </div>

                    <div class="dropdown-item danger">
                        <i class="fa-solid fa-x"></i> Cancelar OS
                    </div>

                    <div class="dropdown-divider"></div>

                    <div class="dropdown-item">
                        <i class="fa-regular fa-file"></i> Exportar PDF
                    </div>

                </div>
            </div>
        </div>

        <div class="summary-grid">
            <div class="os-card summary">
                <div class="summary-icon blue"><i class="fa-solid fa-box" style="color: #74C0FC;"></i></div>
                <div>
                    <div class="summary-title">Itens</div>
                    <div class="summary-number">
                        {{ payload.items|length }}
                    </div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon orange"><i class="fa-solid fa-truck" style="color: #fc7474;"></i></div>
                <div>
                    <div class="summary-title">Viagens</div>
                    <div class="summary-number">
                        {{ payload.travels|length }}
                    </div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon green"><i class="fa-regular fa-file" style="color: #63E6BE;"></i></div>
                <div>
                    <div class="summary-title">Cotações</div>
                    <div class="summary-number">
                        {{ payload.quotes|length }}
                    </div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon yellow"><i class="fa-solid fa-chart-line" style="color: #FFD43B;"></i></div>
                <div>
                    <div class="summary-title">Status</div>
                    <div class="summary-status">
                        {{ payload.service_order.order_state.type }}
                    </div>
                </div>
            </div>
        </div>

        <div class="route-grid">
            <div class="os-card location" id="card-location">
                <div class="location-header">
                    <div class="location-icon blue-bg">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <div class="location-label">ORIGEM</div>
                        <div class="location-name">
                            {{ payload.origin.nome|upper }} 
                            {% if payload.origin.cod_iata %}
                                ({{ payload.origin.cod_iata }})
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="location-address">
                    {{ payload.origin.logradouro }}, {{ payload.origin.numero }}<br>
                    {{ payload.origin.bairro }} - {{ payload.origin.cidade }}/{{ payload.origin.estado }}<br>
                    CEP: {{ payload.origin.CEP }}
                </div>

                <div class="divider"></div>

                <div class="contact-line">
                    <i class="fa-regular fa-user"></i> 
                    {% if payload.origin.responsavel %}
                        {{ payload.origin.responsavel }}
                    {% else %}
                        Não Informado
                    {% endif %}
                </div>
                <div class="contact-line">
                    <i class="fa-solid fa-phone"></i> 
                    {% if payload.origin.telefone1 %}
                        {{ payload.origin.telefone1 }}
                    {% else %}
                        Não Informado
                    {% endif %}
                </div>
                <div class="contact-line">
                    <i class="fa-regular fa-envelope"></i> 
                    {% if payload.origin.email %}
                        {{ payload.origin.email }}
                    {% else %}
                        Não Informado
                    {% endif %}
                </div>
            </div>

            <div class="arrow-circle">
                <i class="fa-solid fa-arrow-right"></i>
            </div>

            <div class="os-card location" id="card-destination">
                <div class="location-header">
                    <div class="location-icon orange-bg">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <div class="location-label">DESTINO</div>
                        <div class="location-name">
                            {{ payload.destination.nome|upper }} 
                            {% if payload.destination.cod_iata %}
                                ({{ payload.destination.cod_iata }})
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="location-address">
                    {{ payload.destination.logradouro }}, {{ payload.destination.numero }}
                    {% if payload.destination.complemento %}
                    - {{ payload.destination.complemento }}
                    {% endif %}<br>
                    {{ payload.destination.bairro }} - {{ payload.destination.cidade }}/{{ payload.destination.estado}}<br>
                    CEP: {{ payload.destination.CEP }}
                </div>
                <div class="divider"></div>
                <div class="contact">
                    <i class="fa-regular fa-user"></i> 
                    {% if payload.destination.responsavel %}
                        {{ payload.destination.responsavel }}
                    {% else %}
                        Não Informado
                    {% endif %}
                    <br>
                    <i class="fa-regular fa-envelope"></i> 
                    {% if payload.destination.email %}
                        {{ payload.destination.email }}
                    {% else %}
                        Não Informado
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" data-tab="itens"><i class="fa-solid fa-box"></i> Itens 
                    ({{ payload.items|length }})</div>
                <div class="tab" data-tab="viagens"><i class="fa-solid fa-truck"></i> Viagens 
                    ({{ payload.travels|length }})</div>
                <div class="tab" data-tab="cotacoes"><i class="fa-regular fa-file"></i> Cotações 
                    ({{ payload.quotes|length }})</div>
                <div class="tab" data-tab="eventos"><i class="fa-solid fa-chart-line"></i> Eventos 
                    ({{ payload.service_order.service_order_events|length }})</div>
            </div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="itens">
                <div class="os-card table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Serial</th>
                                <th>Modelo</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Viagem</th>
                                <th>Criado em</th>
                                <th>Sub-Itens</th>
                                <th>Eventos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in payload.items %}
                            <tr>
                                <td>{{ item.serial_number }}</td>
                                <td>{{ item.product_model }}</td>
                                <td>{{ item.product_type }}</td>

                                <td>
                                    <span class="badge badge-yellow">
                                        {{ payload.service_order.order_state.type }}
                                    </span>
                                </td>

                                <td>
                                    {% if item.travel_order_id %}
                                    {{ item.travel_order_id }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>

                                <td>
                                    {% if item.created_at %}
                                        {{ item.created_at|slice:"8:10" }}/{{ item.created_at|slice:"5:7" }}/{{ item.created_at|slice:"0:4" }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>

                                <td>
                                    {% if item.sub_itens %}
                                    <button class="btn-subitens" onclick="abrirModalFilhos({{ item.id }})">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>

                                <td>
                                    {% if item.item_events %}
                                    <button class="btn-events" onclick="abrirModalEventosItem({{ item.id }})">
                                        <i class="fa-solid fa-clock"></i>
                                    </button>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane" id="viagens">
                {% for travel in payload.travels %}
                <div class="os-card travel-card">

                    <div class="travel-header" onclick="toggleTravel(this)">
                        <div>
                            <div class="travel-title">
                                Viagem #{{ travel.id }}
                                <span class="badge badge-blue">
                                    Status {{ travel.status.type }}
                                </span>
                            </div>
                            <div class="travel-sub">
                                Criada em {{ travel.created_at|slice:":19" }}
                            </div>
                        </div>

                        <div class="travel-arrow">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>

                    <div class="travel-body">
                        <div class="travel-info-grid">
                            <div>
                                <div class="info-label">Motorista</div>
                                <div class="info-value">{{ travel.driver.name }}</div>
                            </div>
                            <div>
                                <div class="info-label">Transportadora</div>
                                <div class="info-value">{{ travel.carrier.nome }}</div>
                            </div>
                            <div>
                                <div class="info-label">Valor</div>
                                <div class="info-value">
                                    R$ {{ travel.price_charged }}
                                </div>
                            </div>

                            <form method="post">
                            {% csrf_token %}
                                <input type="hidden" name="travel_id" value="{{ travel.id }}">
                                <button type="submit"
                                        class="btn-subitens"
                                        name="travel_events"
                                        value="1"
                                        style="margin-left: 150px;">
                                    <i class="fa-solid fa-plus"></i> Adicionar Evento
                                </button>
                            </form>
                        </div>

                        {% if travel.travel_events %}
                        <div class="events-title">Eventos da Viagem</div>

                        <div class="timeline travel-scroll">

                            {% for ev in travel.travel_events %}
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-card">
                                    {{ ev.description }}
                                    <div class="timeline-meta">
                                        por {{ ev.created_by }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="tab-pane" id="cotacoes">
                <div class="cotacoes-wrapper">
                    {% for quote in payload.quotes %}
                    <div class="os-card cotacao-card">
                        <div class="cotacao-header">
                            <div>
                                <div class="cotacao-title">
                                    Cotação #{{ quote.id }}
                                </div>
                                <div class="cotacao-sub">
                                    Criado por {{ quote.created_by }}
                                </div>
                            </div>
                        </div>

                        <div class="cotacao-grid">
                            <div>
                                <div class="info-label">Transportadora</div>
                                <div class="info-value">{{ quote.carrier.nome }}</div>
                            </div>

                            <div>
                                <div class="info-label">Peso</div>
                                <div class="info-value">{{ quote.total_weight }} kg</div>
                            </div>

                            <div>
                                <div class="info-label">Volume</div>
                                <div class="info-value">{{ quote.total_volume }}</div>
                            </div>

                            <div>
                                <div class="info-label">Valor</div>
                                <div class="info-value green-text">
                                    R$ {{ quote.estimated_price }}
                                </div>
                            </div>

                            <div>
                                <div class="info-label">Prazo</div>
                                <div class="info-value">
                                    {{ quote.estimated_deadline }} dias
                                </div>
                            </div>
                        </div>
                        <button class="btn-success">✔ Aprovar Cotação</button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane" id="eventos">
                <div class="os-card">
                    <div class="timeline-title">Timeline de Eventos</div>
                    <div class="timeline">
                        {% for event in payload.service_order.service_order_events %}
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-card">
                                {{ event.description }}
                                <div class="timeline-meta">
                                    {{ event.created_at|date:"d/m/Y H:i" }} • por {{ event.created_by }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS -->
<!-- MODAL PARA ADICIONAR ITEM -->
<form method="post">
    {% csrf_token %}
    <div class="os-modal-overlay" id="modalNovoItem">
    <div class="os-modal os-modal-lg" id="modalItemContent">
        <div class="os-modal-header">
        <div class="os-modal-title">Adicionar Item</div>
        <div class="os-modal-close" onclick="fecharModalCriarItem()">✕</div>
        </div>

        <div class="os-modal-body" id="modalItemBody">
        <div class="os-modal-description">
            Preencha os dados do item para a OS <b>#{{ payload.service_order.order_number }}</b>
        </div>

        <div id="itemModalAlert" class="item-alert" style="display:none;"></div>
            <input type="hidden" name="service_order_id" value="{{ payload.service_order.id }}">
            <input type="hidden" name="order_number"
       value="{{ payload.service_order.external_order_number|default:payload.service_order.order_number }}">
            <input type="hidden" name="created_by" value="{{ request.user.username }}">

            <div class="form-grid">
            <div class="form-group">
                <label>Serial (principal)</label>
                <input type="text" name="serial_number"required>
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" name="product_model" required>
            </div>

            <div class="form-group">
                <label>Item Control</label>
                <input type="text" name="item_control">
            </div>

            <div class="form-group">
                <label>Client ID</label>
                <input type="number" name="client_id" value="0" min="0">
            </div>

            <div class="form-group">
                <label>Peso (kg)</label>
                <input type="number" name="weight" value="0" step="0.01" min="0">
            </div>

            <div class="form-group">
                <label>Altura (cm)</label>
                <input type="number" name="height" value="0" step="0.01" min="0">
            </div>

            <div class="form-group">
                <label>Comprimento (cm)</label>
                <input type="number" name="length" value="0" step="0.01" min="0">
            </div>

            <div class="form-group">
                <label>Largura (cm)</label>
                <input type="number" name="width" value="0" step="0.01" min="0">
            </div>
            </div>

            <div class="form-group" style="margin-bottom:18px;">
            <label>Extra Information (JSON)</label>
            <textarea name="extra_information" rows="3" placeholder='{"chave":"valor"}'></textarea>
            </div>

            <div class="items-box">
                <div class="items-title" style="display:flex;justify-content:space-between;align-items:center;">
                    <span>Sub-itens</span>
                    <button type="button" class="btn-primary" style="padding:8px 12px;" onclick="addSubItemRow()">
                    + Adicionar Sub-item
                    </button>
                </div>

                <div id="subItensContainer" class="subitens-container">
                    <!-- linhas entram via JS -->
                </div>
            </div>
        </div>

        <div class="os-modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharModalCriarItem()">Cancelar</button>
        <button type="submit" class="btn-primary" name="criar_item" value="1">Salvar Item</button>
        </div>
    </div>
    </div>
</form>

<!-- MODAL PARA CRIAR VIAGEM -->
<form method="post">
    {% csrf_token %}
    <input type="hidden" name="service_order_id" value="{{ payload.service_order.id }}">
    <div class="os-modal-overlay" id="modalNovaViagem">
        <div class="os-modal">
            <div class="os-modal-header">
                <div class="os-modal-title">
                    Nova Viagem
                </div>
                <div class="os-modal-close" onclick="fecharModal()">✕</div>
            </div>

            <div class="os-modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Transportadora</label>
                        <select name="carrier_id" id="carrierSelectViagem" required>
                            <option value="">Selecione uma transportadora...</option>
                            {% for carrier in carriers %}
                            <option value="{{ carrier.id }}">{{ carrier.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Motorista</label>
                        <input type="text" id="driverSearch" placeholder="Digite o nome do motorista..." autocomplete="off">
                        <input type="hidden" name="driver_id" id="driverId">
                        <div id="driverResults" class="driver-dropdown"></div>
                    </div>

                    <div class="form-group">
                        <label>Veículo</label>
                        <input type="text"
                            id="vehicleSearch"
                            placeholder="Digite a placa..."
                            autocomplete="off">
                        <input type="hidden" name="vehicle_id" id="vehicleId">
                        <div id="vehicleResults" class="driver-dropdown"></div>
                    </div>

                    <div class="form-group">
                        <label>Cotação (opcional)</label>
                        <select name="quote_id">
                            <option>Selecionar cotação...</option>
                            {% for quote in payload.quotes %}
                            <option value="{{ quote.id }}">{{ quote.carrier.nome }} - R${{ quote.estimated_price }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Valor Cobrado (R$)</label>
                        <input type="number" name="price_charged" value="0" step="0.01" min="0">
                    </div>
                </div>

                <div class="items-box">
                    <div class="items-title">Itens da Viagem</div>
                    {% for item in payload.items %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="items" value="{{ item.id }}">
                        {{ item.description }} <span>({{ item.serial_number }})</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="os-modal-footer">
                <button class="btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn-primary" name="criar_viagem">Criar Viagem</button>
            </div>
        </div>
    </div>
</form>
<!-- MODAL PARA CRIAR COTAÇÃO -->
<form method="post">
    {% csrf_token %}

    <!-- manda a OS no POST -->
    <input type="hidden" name="service_order_id" value="{{ payload.service_order.id }}">

    <div class="os-modal-overlay" id="modalNovaCotacao">
        <div class="os-modal modal-lg">
            <div class="os-modal-header">
                <div class="os-modal-title">Nova Cotação</div>
                <div class="os-modal-close" onclick="fecharModalCotacao()">✕</div>
            </div>

            <div class="os-modal-body">
                <div class="os-modal-description">
                    Preencha os dados para criar uma nova cotação para a OS #{{ payload.service_order.order_number }}
                </div>

                <div class="form-group">
                    <label>Transportadora</label>
                    <select name="carrier_id" style="margin-bottom: 10px;" required>
                        <option value="">Selecione uma transportadora...</option>
                        {% for carrier in carriers %}
                        <option value="{{ carrier.id }}">{{ carrier.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Origem</label>
                        <select name="origin_id" required>
                            <option value="">Selecionar origem...</option>
                            {% for g in grupos %}
                            <option value="{{ g.id }}">
                                {% if g.group.name == "arancia_CD" %}
                                    [CD]
                                {% elif g.group.name == "arancia_PA" %}
                                    [PA]
                                {% elif g.group.name == "arancia_CUSTOMER" %}
                                    [CUSTOMER]
                                {% endif %}
                                {{ g.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Destino</label>
                        <select name="destination_id" required>
                            <option value="">Selecionar destino...</option>
                            {% for g in grupos %}
                            <option value="{{ g.id }}">
                                {% if g.group.name == "arancia_CD" %}
                                    [CD]
                                {% elif g.group.name == "arancia_PA" %}
                                    [PA]
                                {% elif g.group.name == "arancia_CUSTOMER" %}
                                    [CUSTOMER]
                                {% endif %}
                                {{ g.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Peso Total (kg)</label>
                        <input type="number" name="total_weight" value="0" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Volume Total (m³)</label>
                        <input type="number" name="total_volume" value="0" step="0.0001" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Valor Estimado (R$)</label>
                        <input type="number" name="estimated_price" value="0" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Prazo (dias)</label>
                        <input type="number" name="estimated_deadline" value="0" step="1" min="0" required>
                    </div>
                </div>
            </div>

            <div class="os-modal-footer">
                <button type="button" class="btn-secondary" onclick="fecharModalCotacao()">Cancelar</button>
                <button type="submit" class="btn-primary" name="criar_cotacao" value="1">Criar Cotação</button>
            </div>
        </div>
    </div>
</form>
<!-- MODAL PARA SUB-ITENS -->
<div class="os-modal-overlay" id="modalFilhos">
    <div class="os-modal" style="width:600px;">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Seriais Filhos
            </div>
            <div class="os-modal-close" onclick="fecharModalFilhos()">✕</div>
        </div>

        <div class="os-modal-body" id="modalFilhosBody">
        </div>
    </div>
</div>
<!-- MODAL PARA EVENTOS -->
<div class="os-modal-overlay" id="modalEventosItem">
    <div class="os-modal" style="width:650px;">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Histórico do Item
            </div>
            <div class="os-modal-close" onclick="fecharModalEventosItem()">✕</div>
        </div>

        <div class="os-modal-body" id="modalEventosItemBody">
        </div>
    </div>
</div>

<!-- MODAL PARA CRIACAO DE EVENTOS NAS TRAVELS -->
<div class="os-modal-overlay" id="modalEventosTravel">
    <div class="os-modal" style="width:700px;">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Eventos da Viagem
            </div>
            <div class="os-modal-close" onclick="fecharModalEventosTravel()">✕</div>
        </div>

        <div class="os-modal-body">

            <input type="hidden" id="travelEventId">

            <div class="form-group" style="margin-bottom:15px;">
                <label>Novo Evento</label>
                <textarea id="travelEventDescription" rows="3"
                            placeholder="Descreva o evento..."></textarea>
            </div>

            <button class="btn-primary"
                    style="margin-bottom:20px;"
                    onclick="criarEventoTravel()">
                Adicionar Evento
            </button>

            <div id="travelEventsList" class="timeline modal-scroll-limit"></div>

        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".tabs .tab");
        const panes = document.querySelectorAll(".tab-content .tab-pane");

        tabs.forEach(tab => {
            tab.addEventListener("click", function () {

                const targetId = this.dataset.tab;

                tabs.forEach(t => t.classList.remove("active"));
                panes.forEach(p => p.classList.remove("active"));

                this.classList.add("active");

                const targetPane = document.getElementById(targetId);
                if (targetPane) {
                    targetPane.classList.add("active");
                }
            });
        });

        const toggle = document.querySelector(".dropdown-toggle");
        const menu = document.querySelector(".dropdown-menu");

        if (toggle && menu) {
            toggle.addEventListener("click", function (e) {
                e.stopPropagation();
                menu.classList.toggle("show");
            });

            document.addEventListener("click", function () {
                menu.classList.remove("show");
            });
        }

        const modalViagem = document.getElementById("modalNovaViagem");

        window.abrirModal = function () {
            modalViagem.classList.add("show");
        };

        window.fecharModal = function () {
            modalViagem.classList.remove("show");
        };

        if (modalViagem) {
            modalViagem.addEventListener("click", function (e) {
                if (e.target === modalViagem) {
                    fecharModal();
                }
            });
        }

        const modalCotacao = document.getElementById("modalNovaCotacao");

        window.abrirModalCotacao = function () {
            modalCotacao.classList.add("show");
        };

        window.fecharModalCotacao = function () {
            modalCotacao.classList.remove("show");
        };

        if (modalCotacao) {
            modalCotacao.addEventListener("click", function (e) {
                if (e.target === modalCotacao) {
                    fecharModalCotacao();
                }
            });
        }

        const modalFilhos = document.getElementById("modalFilhos");
        const modalFilhosBody = document.getElementById("modalFilhosBody");

        const filhosData = {
            {% for item in payload.items %}
        {% if item.sub_itens %}
        "{{ item.id }}": [
            {% for sub in item.sub_itens %}
                            {
            serial: "{{ sub.serial_number }}",
            model: "{{ sub.product_model }}",
            type: "{{ sub.product_type }}"
        },
        {% endfor %}
                    ],
        {% endif %}
        {% endfor %}
        };

    window.abrirModalFilhos = function (itemId) {

        const filhos = filhosData[itemId];

        if (!filhos) return;

        let html = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#0e76bd; color:white;">
                            <th style="padding:10px;">Serial</th>
                            <th style="padding:10px;">Modelo</th>
                            <th style="padding:10px;">Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        filhos.forEach(f => {
            html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;">${f.serial}</td>
                        <td style="padding:10px;">${f.model}</td>
                        <td style="padding:10px;">${f.type}</td>
                    </tr>
                `;
        });

        html += `</tbody></table>`;

        modalFilhosBody.innerHTML = html;
        modalFilhos.classList.add("show");
    };

    window.fecharModalFilhos = function () {
        modalFilhos.classList.remove("show");
    };

    modalFilhos.addEventListener("click", function (e) {
        if (e.target === modalFilhos) {
            fecharModalFilhos();
        }
    });

    window.toggleTravel = function (element) {

        const card = element.closest(".travel-card");

        // Fecha outras viagens abertas (opcional)
        document.querySelectorAll(".travel-card").forEach(c => {
            if (c !== card) {
                c.classList.remove("active");
            }
        });

        card.classList.toggle("active");
    };

    const eventosItemData = {
            {% for item in payload.items %}
    {% if item.item_events %}
    "{{ item.id }}": [
        {% for ev in item.item_events %}
    {
        description: "{{ ev.description|escapejs }}",
            created_by: "{{ ev.created_by }}",
                id: "{{ ev.id }}"
    },
    {% endfor %}
                    ],
    {% endif %}
    {% endfor %}
        };

    const modalEventosItem = document.getElementById("modalEventosItem");
    const modalEventosItemBody = document.getElementById("modalEventosItemBody");

    window.abrirModalEventosItem = function (itemId) {

        const eventos = eventosItemData[itemId];

        if (!eventos) return;

        let html = `<div class="timeline modal-scroll-limit">`;

        eventos.forEach(ev => {
            html += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card">
                            ${ev.description}
                            <div class="timeline-meta">
                                por ${ev.created_by}
                            </div>
                        </div>
                    </div>
                `;
        });

        html += `</div>`;

        modalEventosItemBody.innerHTML = html;
        modalEventosItem.classList.add("show");
    };

    window.fecharModalEventosItem = function () {
        modalEventosItem.classList.remove("show");
    };

    modalEventosItem.addEventListener("click", function (e) {
        if (e.target === modalEventosItem) {
            fecharModalEventosItem();
        }
    });

    });
</script>

<!-- JS PARA MODAL DE ITENS -->
<script>
  const modalNovoItem = document.getElementById("modalNovoItem");

  window.abrirModalCriarItem = function () {
    modalNovoItem.classList.add("show");

    const container = document.getElementById("subItensContainer");
    if (container.children.length === 0) {
      addSubItemRow();
    }
  };

  window.fecharModalCriarItem = function () {
    modalNovoItem.classList.remove("show");
  };

  if (modalNovoItem) {
    modalNovoItem.addEventListener("click", function (e) {
      if (e.target === modalNovoItem) {
        fecharModalCriarItem();
      }
    });
  }

  window.addSubItemRow = function () {
    const container = document.getElementById("subItensContainer");
    const row = document.createElement("div");
    row.className = "subitem-row";

    row.innerHTML = `
      <div class="form-group">
        <label>Serial</label>
        <input type="text" name="sub_serial[]" />
      </div>

      <div class="form-group">
        <label>Modelo</label>
        <input type="text" name="sub_model[]" />
      </div>

      <div class="form-group">
        <label>Tipo</label>
        <input type="text" name="sub_type[]" />
      </div>

      <div class="form-group">
        <label>Item Control</label>
        <input type="text" name="sub_control[]" />
      </div>

      <div class="form-group">
        <label>Peso</label>
        <input type="number" name="sub_weight[]" value="0" step="0.01" min="0">
      </div>

      <div class="form-group">
        <label>Altura</label>
        <input type="number" name="sub_height[]" value="0" step="0.01" min="0">
      </div>

      <div class="form-group">
        <label>Comp.</label>
        <input type="number" name="sub_length[]" value="0" step="0.01" min="0">
      </div>

      <div class="form-group">
        <label>Larg.</label>
        <input type="number" name="sub_width[]" value="0" step="0.01" min="0">
      </div>

      <button type="button" class="remove-subitem" onclick="this.parentElement.remove()">
        ✕
      </button>
    `;

    container.appendChild(row);
  };
</script>

<!-- BUSCAR MOTORISTAS DIGITANDO -->
<script>
document.addEventListener("DOMContentLoaded", function(){

    const input = document.getElementById("driverSearch");
    const resultsBox = document.getElementById("driverResults");
    const hiddenId = document.getElementById("driverId");
    const carrierSelect = document.querySelector("select[name='carrier_id']");

    let timeout = null;

    input.addEventListener("keyup", function(){

        const query = this.value.trim();
        const carrierId = carrierSelect.value;

        clearTimeout(timeout);

        if(query.length < 2){
            resultsBox.style.display = "none";
            return;
        }

        timeout = setTimeout(() => {

            fetch("{% url 'transportes:buscar_motoristas' %}?nome=" + query + "&carrier_id=" + carrierId)
                .then(res => res.json())
                .then(data => {

                    resultsBox.innerHTML = "";

                    if(!data.items.length){
                        resultsBox.style.display = "none";
                        return;
                    }

                    data.items.forEach(driver => {

                        const div = document.createElement("div");
                        div.classList.add("driver-item");
                        div.innerText = driver.name;

                        div.onclick = function(){
                            input.value = driver.name;
                            hiddenId.value = driver.uid;
                            resultsBox.style.display = "none";
                        }

                        resultsBox.appendChild(div);
                    });

                    resultsBox.style.display = "block";
                });

        }, 300); // debounce
    });

    document.addEventListener("click", function(e){
        if(!input.contains(e.target)){
            resultsBox.style.display = "none";
        }
    });

});
</script>

<!-- BUSCAR VEICULOS -->
<script>
document.addEventListener("DOMContentLoaded", function(){

    const carrierSelect = document.getElementById("carrierSelectViagem");
    const vehicleSelect = document.getElementById("vehicleSelect");

    carrierSelect.addEventListener("change", function(){

        const carrierId = this.value;

        vehicleSelect.innerHTML = '<option value="">Carregando...</option>';

        if(!carrierId){
            vehicleSelect.innerHTML = '<option value="">Selecione um veículo...</option>';
            return;
        }

        fetch("{% url 'transportes:buscar_veiculos' %}?carrier_id=" + carrierId)
            .then(res => res.json())
            .then(data => {

                vehicleSelect.innerHTML = '<option value="">Selecione um veículo...</option>';

                if(!data.items.length){
                    vehicleSelect.innerHTML = '<option value="">Nenhum veículo encontrado</option>';
                    return;
                }

                data.items.forEach(vehicle => {

                    const option = document.createElement("option");
                    option.value = vehicle.id;
                    option.textContent = vehicle.plate + " - " + (vehicle.model || "");

                    vehicleSelect.appendChild(option);
                });

            })
            .catch(() => {
                vehicleSelect.innerHTML = '<option value="">Erro ao carregar veículos</option>';
            });

    });

});

document.addEventListener("DOMContentLoaded", function(){

    const input = document.getElementById("vehicleSearch");
    const resultsBox = document.getElementById("vehicleResults");
    const hiddenId = document.getElementById("vehicleId");
    const carrierSelect = document.getElementById("carrierSelectViagem");

    let timeout = null;

    input.addEventListener("keyup", function(){

        const plate = this.value.trim();
        const carrierId = carrierSelect.value;

        clearTimeout(timeout);

        if(!carrierId){
            resultsBox.style.display = "none";
            return;
        }

        if(plate.length < 2){
            resultsBox.style.display = "none";
            return;
        }

        timeout = setTimeout(() => {

            fetch("{% url 'transportes:buscar_veiculos' %}?carrier_id=" 
                    + carrierId + "&plate=" + plate)

                .then(res => res.json())
                .then(data => {

                    resultsBox.innerHTML = "";

                    if(!data.items.length){
                        resultsBox.style.display = "none";
                        return;
                    }

                    data.items.forEach(vehicle => {

                        const div = document.createElement("div");
                        div.classList.add("driver-item");

                        div.innerHTML = `
                            <strong>${vehicle.plate}</strong>
                            <small style="color:#777;">
                                ${vehicle.model || ""}
                            </small>
                        `;

                        div.onclick = function(){
                            input.value = vehicle.plate + " - " + (vehicle.model || "");
                            hiddenId.value = vehicle.id;
                            resultsBox.style.display = "none";
                        }

                        resultsBox.appendChild(div);
                    });

                    resultsBox.style.display = "block";
                });

        }, 300);
    });

    document.addEventListener("click", function(e){
        if(!input.contains(e.target)){
            resultsBox.style.display = "none";
        }
    });

});
</script>
{% endblock content %}
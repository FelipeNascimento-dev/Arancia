{% extends 'global/base.html' %}

{% block content %}

<style>
    .os-container {
        margin-left: 50px;
        margin-top: 50px;
        /* width: calc(100% - 80px); */
        height: auto;
    }

    .os-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        width: 100%;
    }

    #card-location,
    #card-destination {
        transition: 0.2s;
        cursor: pointer;
        height: 250px;
        min-width: 625px;
    }

    .content-wrapper {
        padding: 30px;
    }

    .header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .os-card.header {
        width: 100%;
        min-width: 100%;
        box-sizing: border-box;
    }

    .header-left {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .icon-box {
        background: #e8f2ff;
        padding: 14px;
        border-radius: 10px;
        font-size: 20px;
    }

    .title {
        font-size: 20px;
        font-weight: 600;
    }

    .subtitle {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
    }

    .btn-primary {
        background: #1e90ff;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .summary {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .summary-number {
        font-size: 22px;
        font-weight: 600;
    }

    .summary-status {
        font-size: 18px;
        font-weight: 600;
    }

    .summary-icon {
        padding: 14px;
        border-radius: 10px;
        font-size: 18px;
    }

    .blue {
        background: #e8f2ff;
    }

    .orange {
        background: #fff2e8;
    }

    .green {
        background: #e9f7ef;
    }

    .yellow {
        background: #fff9e6;
    }

    .route-grid {
        display: grid;
        grid-template-columns: 1fr 80px 1fr;
        gap: 20px;
        align-items: center;
        margin-bottom: 25px;
    }

    .location-name {
        font-size: 18px;
        font-weight: 600;
        margin: 5px 0;
    }

    .location-address,
    .contact {
        font-size: 13px;
        color: #555;
        line-height: 1.6;
    }

    .divider {
        border-top: 1px solid #eee;
        margin: 15px 0;
    }

    .arrow {
        text-align: center;
        font-size: 24px;
        color: #bbb;
    }

    .table-card {
        padding: 0;
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #0e76bd;
        color: white;
    }

    th,
    td {
        padding: 14px 16px;
        font-size: 14px;
    }

    tbody tr {
        border-bottom: 1px solid #eee;
    }

    table th,
    table td {
        text-align: center;
        vertical-align: middle;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-yellow {
        background: #ffd54f;
    }

    .badge-blue {
        background: #2196f3;
        color: white;
    }

    .tab.active-solid {
        background: #0e76bd;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
    }

    .actions-row {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 15px;
    }

    .travel-card {
        padding: 0;
        margin-bottom: 20px;
        overflow: hidden;
        transition: all 0.25s ease;
    }

    .travel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 18px 20px;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .travel-header:hover {
        background: #f4f6f9;
    }

    .travel-body {
        max-height: 0;
        overflow: hidden;
        padding: 0 20px;
        transition: all 0.3s ease;
        opacity: 0;
    }

    .travel-card.active .travel-body {
        max-height: 500px;
        padding: 20px;
        opacity: 1;
    }

    .travel-arrow {
        font-size: 16px;
        color: #999;
        transition: transform 0.3s ease;
    }

    .travel-card.active .travel-arrow {
        transform: rotate(180deg);
    }

    .travel-title {
        font-size: 18px;
        font-weight: 600;
    }

    .travel-sub {
        font-size: 13px;
        color: #666;
        margin-top: 4px;
    }

    .travel-info-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .info-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 14px;
        font-weight: 500;
    }

    .travel-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-secondary {
        background: #bebebe;
        border: 1px solid #ddd;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    .events-title {
        font-weight: 500;
        margin-bottom: 15px;
    }

    .event-item {
        display: flex;
        gap: 10px;
        background: #f4f6f9;
        padding: 14px;
        border-radius: 8px;
        font-size: 14px;
    }

    .event-dot {
        width: 8px;
        height: 8px;
        background: #0e76bd;
        border-radius: 50%;
        margin-top: 6px;
    }

    .event-author {
        font-size: 12px;
        color: #666;
        margin-top: 6px;
    }

    .arrow-collapse {
        font-size: 18px;
        color: #999;
    }

    .tabs-wrapper {
        background: #f4f6f9;
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .tabs {
        display: flex;
        gap: 10px;
    }

    .tab {
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        color: #555;
        font-weight: 500;
        transition: 0.2s;
    }

    .tab.active {
        background: #0e76bd;
        color: white;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .cotacao-card {
        width: 100%;
        max-width: 400px;
        margin-bottom: 20px;
    }

    .cotacao-header {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
    }

    .cotacao-title {
        font-size: 16px;
        font-weight: 600;
    }

    .cotacao-sub {
        font-size: 12px;
        color: #777;
    }

    .cotacao-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .btn-success {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: #28a745;
        color: white;
        font-weight: 500;
        cursor: pointer;
    }

    .green-text {
        color: #28a745;
    }

    .timeline-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .timeline {
        position: relative;
        padding-left: 20px;
    }

    .timeline-item {
        border-left: 2px solid #ddd;
        padding-left: 15px;
        margin-left: 5px;
    }

    /* .timeline::before {
        content: "";
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #ddd;
    } */

    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }

    .timeline-dot {
        width: 10px;
        height: 10px;
        background: #0e76bd;
        border-radius: 50%;
        position: absolute;
        left: -5.6px;
        top: 28px;
    }

    .timeline-card {
        background: #f4f6f9;
        padding: 15px;
        border-radius: 10px;
        font-size: 14px;
    }

    .timeline-meta {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
    }

    .dropdown {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        right: 0;
        top: 110%;
        background: white;
        width: 220px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 8px 0;
        display: none;
        z-index: 1000;
        animation: fadeIn 0.15s ease-in-out;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
    }

    .dropdown-item:hover {
        background: #f4f6f9;
    }

    .dropdown-divider {
        height: 1px;
        background: #eee;
        margin: 6px 0;
    }

    .dropdown-item.success {
        color: #28a745;
        font-weight: 500;
    }

    .dropdown-item.danger {
        color: #dc3545;
        font-weight: 500;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .location {
        padding: 22px;
    }

    .location-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .location-icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }

    .blue-bg {
        background: #e8f2ff;
        color: #1e90ff;
    }

    .orange-bg {
        background: #fff2e8;
        color: #ff7a00;
    }

    .location-label {
        font-size: 12px;
        font-weight: 600;
        color: #888;
        letter-spacing: 1px;
    }

    .location-name {
        font-size: 17px;
        font-weight: 600;
        margin-top: 2px;
    }

    .location-address {
        font-size: 13px;
        color: #555;
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .contact-line {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #444;
        margin-bottom: 6px;
    }

    .contact-line i {
        color: #999;
        font-size: 13px;
    }

    .arrow-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #e8f2ff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1e90ff;
        font-size: 16px;
        margin-left: 15px;
    }


    /* MODAL PARA CRIAR VIAGEM */

    /* MODAL */
    .os-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .os-modal-overlay.show {
        display: flex;
    }

    .os-modal {
        background: white;
        width: 650px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        animation: modalFade 0.2s ease-in-out;
    }

    @keyframes modalFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .os-modal-header {
        padding: 18px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
    }

    .os-modal-title {
        font-weight: 600;
        font-size: 18px;
    }

    .os-modal-close {
        cursor: pointer;
        font-size: 18px;
        color: #777;
    }

    .os-modal-body {
        padding: 20px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 18px;
        margin-bottom: 20px;
    }

    .form-group label {
        font-size: 13px;
        color: #555;
        margin-bottom: 6px;
        display: block;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    .items-box {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        background: #f9fafc;
    }

    .items-title {
        font-weight: 500;
        margin-bottom: 10px;
    }

    .checkbox-item {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 14px;
        cursor: pointer;
    }

    .checkbox-item span {
        color: #777;
    }

    .os-modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .os-modal-lg {
        width: 720px;
    }

    .os-modal-description {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
    }

    .tab-content {
        width: 100%;
        overflow: visible;
    }

    .tab-pane {
        width: 100%;
    }

    .tab-content {
        display: block !important;
        width: 100%;
    }

    .tab-pane {
        display: none;
        width: 100%;
    }

    .tab-pane.active {
        display: block !important;
    }

    .content-wrapper {
        display: block !important;
    }

    .os-container {
        display: block !important;
    }

    .btn-subitens {
        background-color: transparent;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        color: black;
        cursor: pointer;
        font-size: 15px;
    }

    .btn-events{
        background-color: transparent;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        color: black;
        cursor: pointer;
        font-size: 15px;
    }

    .modal-scroll-limit {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 6px;
    }

    .travel-scroll {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 8px;
    }

    .cotacoes-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
    }
</style>

<div class="os-container">
    <div class="content-wrapper">
        <div class="os-card header">
            <div class="header-left">
                <div class="icon-box"><i class="fa-solid fa-box" style="color: #74C0FC;"></i></div>
                <div>
                    <div class="title">
                        #{{ payload.service_order.order_number }}
                        <span class="badge badge-yellow">
                            {{ payload.service_order.order_state.type }}
                        </span>
                    </div>
                    <div class="subtitle">
                        Tipo: {{ payload.service_order.order_type.description }}
                        • Criado por: {{ payload.service_order.created_by }}
                        • Data: {{ payload.service_order.created_at|date:"d/m/Y H:i" }}
                    </div>
                </div>
            </div>

            <div class="dropdown">
                <button class="btn-primary dropdown-toggle">
                    Ações ▾
                </button>

                <div class="dropdown-menu">

                    <div class="dropdown-item" onclick="abrirModalCotacao()">
                        <i class="fa-solid fa-plus"></i> Adicionar Cotação
                    </div>

                    <div class="dropdown-item" onclick="abrirModal()">
                        <i class="fa-solid fa-truck"></i> Criar Viagem
                    </div>

                    <div class="dropdown-divider"></div>

                    <div class="dropdown-item success">
                        <i class="fa-solid fa-check"></i> Finalizar OS
                    </div>

                    <div class="dropdown-item danger">
                        <i class="fa-solid fa-x"></i> Cancelar OS
                    </div>

                    <div class="dropdown-divider"></div>

                    <div class="dropdown-item">
                        <i class="fa-regular fa-file"></i> Exportar PDF
                    </div>

                </div>
            </div>
        </div>

        <div class="summary-grid">
            <div class="os-card summary">
                <div class="summary-icon blue"><i class="fa-solid fa-box" style="color: #74C0FC;"></i></div>
                <div>
                    <div class="summary-title">Itens</div>
                    <div class="summary-number">
                        {{ payload.items|length }}
                    </div>
                    <div class="summary-sub">equipamentos</div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon orange"><i class="fa-solid fa-truck" style="color: #fc7474;"></i></div>
                <div>
                    <div class="summary-title">Viagens</div>
                    <div class="summary-number">
                        {{ payload.travels|length }}
                    </div>
                    <div class="summary-sub">ativa</div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon green"><i class="fa-regular fa-file" style="color: #63E6BE;"></i></div>
                <div>
                    <div class="summary-title">Cotações</div>
                    <div class="summary-number">
                        {{ payload.quotes|length }}
                    </div>
                    <div class="summary-sub">criada</div>
                </div>
            </div>

            <div class="os-card summary">
                <div class="summary-icon yellow"><i class="fa-solid fa-chart-line" style="color: #FFD43B;"></i></div>
                <div>
                    <div class="summary-title">Status</div>
                    <div class="summary-status">
                        {{ payload.service_order.order_state.type }}
                    </div>
                </div>
            </div>
        </div>

        <div class="route-grid">
            <div class="os-card location" id="card-location">
                <div class="location-header">
                    <div class="location-icon blue-bg">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <div class="location-label">ORIGEM</div>
                        <div class="location-name">
                            {{ payload.origin.nome|upper }} ({{ payload.origin.cod_iata }})
                        </div>
                    </div>
                </div>

                <div class="location-address">
                    {{ payload.origin.logradouro }}, {{ payload.origin.numero }}<br>
                    {{ payload.origin.bairro }} - {{ payload.origin.cidade }}/{{ payload.origin.estado }}<br>
                    CEP: {{ payload.origin.CEP }}
                </div>

                <div class="divider"></div>

                <div class="contact-line">
                    <i class="fa-regular fa-user"></i> {{ payload.origin.responsavel }}
                </div>
                <div class="contact-line">
                    <i class="fa-solid fa-phone"></i> {{ payload.origin.telefone1 }}
                </div>
                <div class="contact-line">
                    <i class="fa-regular fa-envelope"></i> {{ payload.origin.email }}
                </div>
            </div>

            <div class="arrow-circle">
                <i class="fa-solid fa-arrow-right"></i>
            </div>

            <div class="os-card location" id="card-destination">
                <div class="location-header">
                    <div class="location-icon orange-bg">
                        <i class="fa-solid fa-location-dot"></i>
                    </div>
                    <div>
                        <div class="location-label">DESTINO</div>
                        <div class="location-name">
                            {{ payload.destination.nome|upper }} ({{ payload.destination.cod_iata }})
                        </div>
                    </div>
                </div>
                <div class="location-address">
                    {{ payload.destination.logradouro }}, {{ payload.destination.numero }}
                    {% if payload.destination.complemento %}
                        - {{ payload.destination.complemento }}
                    {% endif %}<br>
                    {{ payload.destination.bairro }} - {{ payload.destination.cidade }}/{{ payload.destination.estado }}<br>
                    CEP: {{ payload.destination.CEP }}
                </div>
                <div class="divider"></div>
                <div class="contact">
                    <i class="fa-regular fa-user"></i> {{ payload.destination.responsavel }}<br>
                    <i class="fa-regular fa-envelope"></i> {{ payload.destination.email }}
                </div>
            </div>
        </div>

        <div class="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" data-tab="itens"><i class="fa-solid fa-box"></i> Itens ({{ payload.items|length }})</div>
                <div class="tab" data-tab="viagens"><i class="fa-solid fa-truck"></i> Viagens ({{ payload.travels|length }})</div>
                <div class="tab" data-tab="cotacoes"><i class="fa-regular fa-file"></i> Cotações ({{ payload.quotes|length }})</div>
                <div class="tab" data-tab="eventos"><i class="fa-solid fa-chart-line"></i> Eventos ({{ payload.service_order.service_order_events|length }})</div>
            </div>
        </div>

        <div class="tab-content">
            <div class="tab-pane active" id="itens">
                <div class="os-card table-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Serial</th>
                                <th>Modelo</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Viagem</th>
                                <th>Criado em</th>
                                <th>Sub-Itens</th>
                                <th>Eventos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in payload.items %}
                                <tr>
                                    <td>{{ item.serial_number }}</td>
                                    <td>{{ item.product_model }}</td>
                                    <td>{{ item.product_type }}</td>

                                    <td>
                                        <span class="badge badge-yellow">
                                            {{ payload.service_order.order_state.type }}
                                        </span>
                                    </td>

                                    <td>
                                        {% if item.travel_order_id %}
                                            {{ item.travel_order_id }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>

                                    <td>
                                        {{ item.created_at|slice:":10" }}
                                    </td>

                                    <td>
                                        {% if item.sub_itens %}
                                            <button class="btn-subitens"
                                                    onclick="abrirModalFilhos({{ item.id }})">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>

                                    <td>
                                        {% if item.item_events %}
                                            <button class="btn-events"
                                                    onclick="abrirModalEventosItem({{ item.id }})">
                                                <i class="fa-solid fa-clock"></i>
                                            </button>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane" id="viagens">
               {% for travel in payload.travels %}
                <div class="os-card travel-card">

                    <div class="travel-header" onclick="toggleTravel(this)">
                        <div>
                            <div class="travel-title">
                                Viagem #{{ travel.id }}
                                <span class="badge badge-blue">
                                    Status {{ travel.status_id }}
                                </span>
                            </div>
                            <div class="travel-sub">
                                Criada em {{ travel.created_at|slice:":19" }}
                            </div>
                        </div>

                        <div class="travel-arrow">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>

                    <div class="travel-body">
                        <div class="travel-info-grid">
                            <div>
                                <div class="info-label">Motorista</div>
                                <div class="info-value">{{ travel.driver_id }}</div>
                            </div>
                            <div>
                                <div class="info-label">Transportadora</div>
                                <div class="info-value">{{ travel.carrier_id }}</div>
                            </div>
                            <div>
                                <div class="info-label">Valor</div>
                                <div class="info-value">
                                    R$ {{ travel.price_charged }}
                                </div>
                            </div>
                        </div>

                        {% if travel.travel_events %}
                        <div class="events-title">Eventos da Viagem</div>

                        <div class="timeline travel-scroll">

                            {% for ev in travel.travel_events %}
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-card">
                                    {{ ev.description }}
                                    <div class="timeline-meta">
                                        por {{ ev.created_by }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="tab-pane" id="cotacoes">
                <div class="cotacoes-wrapper">
                    {% for quote in payload.quotes %}
                    <div class="os-card cotacao-card">
                        <div class="cotacao-header">
                            <div>
                                <div class="cotacao-title">
                                    Cotação #{{ quote.id }}
                                </div>
                                <div class="cotacao-sub">
                                    Criado por {{ quote.created_by }}
                                </div>
                            </div>
                        </div>

                        <div class="cotacao-grid">
                            <div>
                                <div class="info-label">Peso</div>
                                <div class="info-value">{{ quote.total_weight }} kg</div>
                            </div>

                            <div>
                                <div class="info-label">Volume</div>
                                <div class="info-value">{{ quote.total_volume }}</div>
                            </div>

                            <div>
                                <div class="info-label">Valor</div>
                                <div class="info-value green-text">
                                    R$ {{ quote.estimated_price }}
                                </div>
                            </div>

                            <div>
                                <div class="info-label">Prazo</div>
                                <div class="info-value">
                                    {{ quote.estimated_deadline }} dias
                                </div>
                            </div>
                        </div>
                        <button class="btn-success">✔ Aprovar Cotação</button>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane" id="eventos">
                <div class="os-card">
                    <div class="timeline-title">Timeline de Eventos</div>
                    <div class="timeline">
                        {% for event in payload.service_order.service_order_events %}
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-card">
                                {{ event.description }}
                                <div class="timeline-meta">
                                    {{ event.created_at|date:"d/m/Y H:i" }} • por {{ event.created_by }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAIS -->

<!-- MODAL PARA CRIAR VIAGEM -->
<div class="os-modal-overlay" id="modalNovaViagem">
    <div class="os-modal">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Nova Viagem
            </div>
            <div class="os-modal-close" onclick="fecharModal()">✕</div>
        </div>

        <div class="os-modal-body">
            <div class="form-grid">
                <div class="form-group">
                    <label>Motorista</label>
                    <select>
                        <option>Buscar motorista...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Transportadora</label>
                    <select>
                        <option>Buscar transportadora...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Veículo</label>
                    <select>
                        <option>Buscar veículo...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select>
                        <option>Selecionar status...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cotação (opcional)</label>
                    <select>
                        <option>Selecionar cotação...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Valor Cobrado (R$)</label>
                    <input type="number" value="0">
                </div>
            </div>

            <div class="items-box">
                <div class="items-title">Itens da Viagem</div>
                <label class="checkbox-item">
                    <input type="checkbox">
                    Notebook Dell XPS <span>(SN-001)</span>
                </label>

                <label class="checkbox-item">
                    <input type="checkbox">
                    Monitor LG 27" <span>(SN-002)</span>
                </label>

                <label class="checkbox-item">
                    <input type="checkbox">
                    Teclado Mecânico <span>(SN-003)</span>
                </label>
            </div>
        </div>
        <div class="os-modal-footer">
            <button class="btn-secondary" onclick="fecharModal()">Cancelar</button>
            <button class="btn-primary">Criar Viagem</button>
        </div>
    </div>
</div>
<!-- MODAL PARA CRIAR COTAÇÃO -->
<div class="os-modal-overlay" id="modalNovaCotacao">
    <div class="os-modal modal-lg">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Nova Cotação
            </div>
            <div class="os-modal-close" onclick="fecharModalCotacao()">✕</div>
        </div>

        <div class="os-modal-body">
            <div class="os-modal-description">
                Preencha os dados para criar uma nova cotação para a OS #609
            </div>

            <div class="form-group">
                <label>Transportadora</label>
                <select>
                    <option>Pesquisar transportadora...</option>
                </select>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Origem</label>
                    <select>
                        <option>Pesquisar...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Destino</label>
                    <select>
                        <option>Pesquisar...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Peso Total (kg)</label>
                    <input type="number" value="0">
                </div>

                <div class="form-group">
                    <label>Volume Total (m³)</label>
                    <input type="number" value="0">
                </div>

                <div class="form-group">
                    <label>Valor Estimado (R$)</label>
                    <input type="number" value="0">
                </div>

                <div class="form-group">
                    <label>Prazo (dias)</label>
                    <input type="number" value="0">
                </div>
            </div>
        </div>
        <div class="os-modal-footer">
            <button class="btn-secondary" onclick="fecharModalCotacao()">Cancelar</button>
            <button class="btn-primary">Criar Cotação</button>
        </div>
    </div>
</div>
<!-- MODAL PARA SUB-ITENS -->
<div class="os-modal-overlay" id="modalFilhos">
    <div class="os-modal" style="width:600px;">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Seriais Filhos
            </div>
            <div class="os-modal-close" onclick="fecharModalFilhos()">✕</div>
        </div>

        <div class="os-modal-body" id="modalFilhosBody">
        </div>
    </div>
</div>
<!-- MODAL PARA EVENTOS -->
<div class="os-modal-overlay" id="modalEventosItem">
    <div class="os-modal" style="width:650px;">
        <div class="os-modal-header">
            <div class="os-modal-title">
                Histórico do Item
            </div>
            <div class="os-modal-close" onclick="fecharModalEventosItem()">✕</div>
        </div>

        <div class="os-modal-body" id="modalEventosItemBody">
        </div>
    </div>
</div>


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".tabs .tab");
        const panes = document.querySelectorAll(".tab-content .tab-pane");

        tabs.forEach(tab => {
            tab.addEventListener("click", function () {

                const targetId = this.dataset.tab;

                tabs.forEach(t => t.classList.remove("active"));
                panes.forEach(p => p.classList.remove("active"));

                this.classList.add("active");

                const targetPane = document.getElementById(targetId);
                if (targetPane) {
                    targetPane.classList.add("active");
                }
            });
        });

        const toggle = document.querySelector(".dropdown-toggle");
        const menu = document.querySelector(".dropdown-menu");

        if (toggle && menu) {
            toggle.addEventListener("click", function (e) {
                e.stopPropagation();
                menu.classList.toggle("show");
            });

            document.addEventListener("click", function () {
                menu.classList.remove("show");
            });
        }

        const modalViagem = document.getElementById("modalNovaViagem");

        window.abrirModal = function () {
            modalViagem.classList.add("show");
        };

        window.fecharModal = function () {
            modalViagem.classList.remove("show");
        };

        if (modalViagem) {
            modalViagem.addEventListener("click", function (e) {
                if (e.target === modalViagem) {
                    fecharModal();
                }
            });
        }

        const modalCotacao = document.getElementById("modalNovaCotacao");

        window.abrirModalCotacao = function () {
            modalCotacao.classList.add("show");
        };

        window.fecharModalCotacao = function () {
            modalCotacao.classList.remove("show");
        };

        if (modalCotacao) {
            modalCotacao.addEventListener("click", function (e) {
                if (e.target === modalCotacao) {
                    fecharModalCotacao();
                }
            });
        }

        const modalFilhos = document.getElementById("modalFilhos");
        const modalFilhosBody = document.getElementById("modalFilhosBody");

        const filhosData = {
            {% for item in payload.items %}
                {% if item.sub_itens %}
                    "{{ item.id }}": [
                        {% for sub in item.sub_itens %}
                            {
                                serial: "{{ sub.serial_number }}",
                                model: "{{ sub.product_model }}",
                                type: "{{ sub.product_type }}"
                            },
                        {% endfor %}
                    ],
                {% endif %}
            {% endfor %}
        };

        window.abrirModalFilhos = function(itemId) {

            const filhos = filhosData[itemId];

            if (!filhos) return;

            let html = `
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:#0e76bd; color:white;">
                            <th style="padding:10px;">Serial</th>
                            <th style="padding:10px;">Modelo</th>
                            <th style="padding:10px;">Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filhos.forEach(f => {
                html += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px;">${f.serial}</td>
                        <td style="padding:10px;">${f.model}</td>
                        <td style="padding:10px;">${f.type}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            modalFilhosBody.innerHTML = html;
            modalFilhos.classList.add("show");
        };

        window.fecharModalFilhos = function() {
            modalFilhos.classList.remove("show");
        };

        modalFilhos.addEventListener("click", function(e) {
            if (e.target === modalFilhos) {
                fecharModalFilhos();
            }
        });

        window.toggleTravel = function(element) {

            const card = element.closest(".travel-card");

            // Fecha outras viagens abertas (opcional)
            document.querySelectorAll(".travel-card").forEach(c => {
                if (c !== card) {
                    c.classList.remove("active");
                }
            });

            card.classList.toggle("active");
        };

        const eventosItemData = {
            {% for item in payload.items %}
                {% if item.item_events %}
                    "{{ item.id }}": [
                        {% for ev in item.item_events %}
                            {
                                description: "{{ ev.description|escapejs }}",
                                created_by: "{{ ev.created_by }}",
                                id: "{{ ev.id }}"
                            },
                        {% endfor %}
                    ],
                {% endif %}
            {% endfor %}
        };

        const modalEventosItem = document.getElementById("modalEventosItem");
        const modalEventosItemBody = document.getElementById("modalEventosItemBody");

        window.abrirModalEventosItem = function(itemId) {

            const eventos = eventosItemData[itemId];

            if (!eventos) return;

            let html = `<div class="timeline modal-scroll-limit">`;

            eventos.forEach(ev => {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-card">
                            ${ev.description}
                            <div class="timeline-meta">
                                por ${ev.created_by}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;

            modalEventosItemBody.innerHTML = html;
            modalEventosItem.classList.add("show");
        };

        window.fecharModalEventosItem = function() {
            modalEventosItem.classList.remove("show");
        };

        modalEventosItem.addEventListener("click", function(e) {
            if (e.target === modalEventosItem) {
                fecharModalEventosItem();
            }
        });

    });
</script>

{% endblock content %}